// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String
  password          String?
  firstName         String?
  lastName          String?
  phoneNumber       String?
  businessName      String?
  businessType      String?
  address           String?
  whatsappNumber    String?
  directChatMessage String?
  role              String    @default("user") // user, admin, customer
  isActive          Boolean   @default(true)
  isDeleted         Boolean   @default(false) // New field for soft delete
  emailVerified     DateTime?
  image             String?

  // Essential fields
  subscriptionExpirationDate DateTime?
  subscriptionLtv   Float     @default(0.00)
  subscriptionPlan  String?
  subscriptionStartDate DateTime?
  termsAccepted     Boolean   @default(false)
  subscriptionStatus String   @default("active")
  
  // Stripe integration
  stripeCustomerId  String?   @unique
  stripeSubscriptionId String?
  
  // Referral system
  referralCode      String?   @unique

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  qrCodes           QRCode[]
  qrCodeScans       QRCodeScan[] // QR code scan history
  supportTickets    SupportTicket[]
  emailVerifications EmailVerification[]
  passwordResets    PasswordReset[]
  
  // Referral relations
  referralsGiven    Referral[] @relation("Referrer")
  referralsReceived Referral[] @relation("ReferredUser")
  
  // Customer relations
  customers         Customers[]      // New customers table relation
  appointments      Appointment[]    // Appointments relation
  customerUsers     CustomerUser[]   // Customer-User relations
  paymentWebhooks   PaymentWebhook[] // Payment webhook relations
  paymentHistory    PaymentHistory[] // Payment history tracking
     reviews           Review[]         // Reviews received by business owner
   conversationStates ConversationState[] // WhatsApp conversation states
   whatsappMessages  whatsappMessage[] // WhatsApp messages sent by business owner
   customerStatusLogs CustomerStatusLog[] // Customer status change logs
   staff              Staff[]           // Staff members for this business
   services           Service[]         // Services for this business

  // ðŸ‘‡ compound unique constraints
  @@unique([email, isDeleted])
  @@unique([businessName, isDeleted])
  @@map("users")
}

// Email verification tokens
model EmailVerification {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

// Password reset tokens
model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model QRCode {
  id                String   @id @default(cuid())
  userId            String
  name              String
  url               String
  qrData            String
  qrCodeImage       String?  // Store the generated QR code image as data URL
  messageForCustomer String? // Custom message for customers
  directMessage     String?  // Direct message for WhatsApp/contact
  directUrl         String?  // Direct URL for business
  messageUrl        String?  // Message URL for customers
  isActive          Boolean  @default(true)
  scanCount         Int      @default(0)
  shareCount        Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  scans QRCodeScan[] // Relationship to scan records

  @@map("qr_codes")
}

// QR Code Scan tracking model
model QRCodeScan {
  id          String   @id @default(cuid())
  qrCodeId    String
  userId      String   // Business owner who owns the QR code
  referrer    String?  // Where the scan came from (URL, app, etc.)
  userAgent   String?  // Browser/device information
  ipAddress   String?  // IP address of the scanner
  scanData    String?  // Additional data from the scan
  sharedata   String?  // Data related to sharing
  scanTime    DateTime @default(now())
  
  // Relations
  qRCode      QRCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("qr_code_scans")
}

model SupportTicket {
  id          String   @id @default(cuid())
  userId      String
  subject     String
  description String
  status      String   @default("open") // open, in_progress, resolved, closed
  priority    String   @default("medium") // low, medium, high, urgent
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("support_tickets")
}

model Referral {
  id                    String   @id @default(cuid())
  status               String   @default("pending") // pending, active, cancelled
  commission           Float    @default(0)
  totalCommissionEarned Float    @default(0) // Total commission earned from this referral
  date                 DateTime @default(now())
  
  // Stripe integration fields
  stripeCouponId       String?  // Stripe coupon ID
  stripePromotionCodeId String? // Stripe promotion code ID  
  promotionCode        String?  // The actual promotion code (e.g., PLUS5-partnerId)
  
  // Commission tracking
  invoicesPaid         Int      @default(0) // Number of invoices paid using this promotion
  lastCommissionDate   DateTime? // Last time commission was calculated
  
  // Relations
  referrerId     String
  referrer       User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  
  referredUserId String
  referredUser   User     @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

// New Customers table - Simple customer information
model Customers {
  id              String   @id @default(cuid())
  
  // Basic fields
  firstName       String?  // First name
  lastName        String?  // Last name
  email           String?  // Customer email address
  
  // Client required fields
  customerPhone   String?  // Customer phone number
  appointmentCount Int?     @default(0) // Number of appointments
  customerFullName String? // Full name in Hebrew/Arabic
  selectedServices String? // Selected services
  endDate         DateTime? // Appointment end date
  duration        String?  // Appointment duration
  startDate       DateTime? // Appointment start date
  businessId      Int?     // Business ID
  employeeId      Int?     // Employee ID
  businessName    String?     // Business Name
  
  // Image fields
  profileImage    String?  // Profile image URL
  coverImage      String?  // Cover image URL
  documentImage   String?  // Document image URL
  
  // Relations
  userId          String?  // Reference to User table (business owner)
  user            User?    @relation(fields: [userId], references: [id])
  appointments    Appointment[] // Appointments relation
  customerUsers   CustomerUser[] // Customer-User relations
  paymentWebhooks PaymentWebhook[] // Payment webhook relations
     reviews         Review[] // Reviews given by customer
   conversationStates ConversationState[] // WhatsApp conversation states
   whatsappMessages whatsappMessage[] // WhatsApp messages for this customer
   customerStatusLogs CustomerStatusLog[] // Customer status change logs
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("customers")
} 

// Appointment table - Store webhook appointment data
model Appointment {
  id              String   @id @default(cuid())
  
  // Webhook data fields
  source          String?
  endDate         DateTime?
  duration        String?
  startDate       DateTime?
  businessId      Int?
  byCustomer      Boolean  @default(false)
  createDate      DateTime?
  employeeId      Int?     // Legacy field - keep for backward compatibility
  businessName    String?
  employeeName    String?
  customerPhone   String?
  appointmentCount Int     @default(0)
  customerFullName String?
  selectedServices String? // Legacy field - keep for backward compatibility
  
  // Relations
  customerId      String?  // Reference to Customers table
  customer        Customers? @relation(fields: [customerId], references: [id])
  userId          String?  // Reference to User table (business owner)
  user            User?    @relation(fields: [userId], references: [id])
  
  // New relations for Staff and Service
  staffId         String?  // Reference to Staff table
  staff           Staff?   @relation(fields: [staffId], references: [id])
  serviceId       String?   // Reference to Service table
  service        Service?  @relation(fields: [serviceId], references: [id])
  
  // Related payments
  payments        PaymentWebhook[] // Payments for this appointment
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("appointments")
}

// Customer_User table - Customer and User relations
model CustomerUser {
  id          String   @id @default(cuid())
  customerId  String   // Reference to Customers table
  userId      String   // Reference to User table
  status      String   @default("active") // active, inactive, blocked
  isDeleted   Boolean  @default(false) // Soft delete flag for customer-user relation
  
  // Relations
  customer    Customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("customer_users")
}

// Customer Status Logs - Track status changes over time
model CustomerStatusLog {
  id          String   @id @default(cuid())
  customerId  String   // Reference to Customers table
  userId      String   // Reference to User table
  oldStatus   String?  // Previous status (can be null for first record)
  newStatus   String   // New status
  reason      String?  // Reason for status change
  changedAt   DateTime @default(now()) // When the status changed
  
  // Relations
  customer    Customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("customer_status_logs")
}

// Conversation State table - Store WhatsApp conversation states
model ConversationState {
  id              String   @id @default(cuid())
  phoneNumber     String   @unique // Customer phone number
  customerName    String?  // Customer name
  step            String   // Conversation step: initial_sent, followup_sent, etc.
  lastMessage     String?  // Last message sent
  customerResponse String? // Customer response type: yes, no, unknown
  status          String   @default("at_risk") // Conversation type: at_risk, at_lost, at_review
  conversationEnded Boolean @default(false) // Is conversation completed
  
  // Timestamps
  startTime       DateTime @default(now()) // When conversation started
  followupTime    DateTime? // When follow-up was sent
  responseTime    DateTime? // When customer responded
  closureTime     DateTime? // When conversation ended
  
  // Relations
  userId          String?  // Reference to User table (business owner)
  customerId      String?  // Reference to Customers table
  user            User?    @relation(fields: [userId], references: [id])
  customer        Customers? @relation(fields: [customerId], references: [id])
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("conversation_states")
}

// New Payment model for webhook data
model PaymentWebhook {
  id                String   @id @default(cuid())
  
  // Payment details
  total             Float    @default(0.00)
  totalWithoutVAT   Float    @default(0.00)
  totalVAT          Float    @default(0.00)
  
  // Customer and Business references
  customerId        String?  // Reference to Customers table (EmployeeId)
  customer          Customers? @relation(fields: [customerId], references: [id])
  userId            String?  // Reference to User table (BusinessId)
  user              User?    @relation(fields: [userId], references: [id])
  
  // Appointment tracking
  appointmentId     String?  // Reference to Appointment table
  appointment       Appointment? @relation(fields: [appointmentId], references: [id])
  
  // Review tracking
  reviews           Review[] // Reviews triggered by this payment
  
  // Additional fields
  paymentDate       DateTime @default(now())
  status            String   @default("success") // success, failed, pending
  customerOldStatus String?  // Previous customer status before payment (lost, at_risk, risk, new, active, etc.)
  revenuePaymentStatus String? // recovered, lost
  
  // Webhook data
  employeeId        Int?
  businessId        Int?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("payment_webhooks")
}

model WebhookLog {
  id          String   @id @default(cuid())
  data        Json     // Store JSON data from webhook body
  createdDate DateTime @default(now())
  status      String   @default("pending") // pending, processed, failed
  type        String   // appointment, payment_checkout
  
  @@map("webhook_logs")
}

// New Payment Webhook Log Model - Completely Different
model WebhookPaymentLog {
  id                String   @id @default(cuid())
  data              Json     // Store JSON data from webhook body
  createdDate       DateTime @default(now())
  type              String   // payment_checkout
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("webhook_payment_logs")
}

// Review Rating table - Store customer reviews and ratings
model Review {
  id          String   @id @default(cuid())
  
  // Review details
  rating      Int      // Rating from 1 to 5
  message     String?  // Customer review message/feedback
  status      String   @default("received") // received, processed, responded
  
  // Relations
  customerId  String   // Reference to Customers table
  customer    Customers @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId      String   // Reference to User table (business owner)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Payment tracking
  paymentWebhookId  String?  // Reference to PaymentWebhook table (which payment triggered this review)
  paymentWebhook    PaymentWebhook? @relation(fields: [paymentWebhookId], references: [id])
  
  // WhatsApp message tracking (optional)
  whatsappMessageId String? // WhatsApp message ID if sent via WhatsApp
  messageStatus     String? @default("sent") // sent, delivered, read, failed
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("reviews")
} 

// WhatsApp Message table - Store customer message Type And bill date
model whatsappMessage {
  id          String   @id @default(cuid())
  
  // Message details
  messageType      String?      // at_risk, lost, recovered
  messageDate      DateTime     @default(now())
  billStatus       Boolean      @default(false)
  billDate         DateTime?
  
  // Relations
  customerId       String       // Reference to Customers table
  customer         Customers    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId           String       // Reference to User table (business owner)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    
  // Timestamps
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@map("whatsappMessage")
}

// Payment History Tracking
model PaymentHistory {
  id                String    @id @default(cuid())
  userId            String    // User who made the payment
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Payment Details
  paymentType       String    // 'subscription' or 'simple'
  amount            Float     // Amount paid
  currency          String    // Currency code (USD, ILS, etc.)
  description       String?   // Payment description
  
  // Stripe Details
  stripeSessionId   String?   // Stripe checkout session ID
  stripePaymentId   String?   // Stripe payment intent ID
  stripeSubscriptionId String? // Stripe subscription ID (for subscriptions)
  stripeCustomerId  String?   // Stripe customer ID
  
  // Payment Status
  status            String    // 'pending', 'succeeded', 'failed', 'canceled'
  paymentMethod     String?   // 'card', 'link', etc.
  
  // Metadata
  metadata          Json?     // Additional payment metadata
  source            String?   // 'email_link', 'dashboard', 'api', etc.
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("paymentHistory")
}

// Staff table - Store staff/employee information for businesses
model Staff {
  id          String   @id @default(cuid())
  
  // Staff details
  fullName    String   // Full name of the staff member
  phone       String   // Phone number (required)
  email       String?  // Email address (optional)
  city        String?  // City (optional)
  address     String?  // Address (optional)
  
  // Business relation
  businessId  String   // Reference to User table (business owner)
  user        User     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Appointments relation
  appointments Appointment[] // Appointments assigned to this staff member
  
  // Status
  isActive    Boolean  @default(true)
  isDeleted   Boolean  @default(false) // Soft delete flag
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("staff")
}

// Service table - Store services/offerings for businesses
model Service {
  id                String   @id @default(cuid())
  
  // Service details
  name              String   // Service name (required)
  notes             String?  // Service notes/description (optional)
  category          String?  // Service category (optional)
  price             Float    // Service price (required)
  duration          Int      // Duration in minutes (required)
  color             String?  // Color code for display (optional, default: #FF257C)
  hideFromClients   Boolean  @default(false) // Hide from client booking (optional)
  
  // Business relation
  businessId        String   // Reference to User table (business owner)
  user              User     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Appointments relation
  appointments      Appointment[] // Appointments using this service
  
  // Status
  isActive          Boolean  @default(true)
  isDeleted         Boolean  @default(false) // Soft delete flag
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("services")
} 